<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Picker</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    
    <!-- Bootstrap 4 CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.1/css/bootstrap.min.css">
    
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px;
        }
        h1, h2 {
            margin-bottom: 20px;
            text-align: center;
        }
        .table-container {
            width: 100%;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            table-layout: fixed;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
            box-shadow: 1px 1px 5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            white-space: nowrap;
        }
        th {
            background-color: #f2f2f2;
            text-align: center; /* Center column headings */
        }
        .scroll-box {
            overflow-x: auto;
            white-space: nowrap;
        }
        .scroll-box td {
            width: 150px;
        }
        .info-box {
            width: 100%;
            border: 1px solid #ddd;
            padding: 8px;
            box-sizing: border-box;
            margin-bottom: 20px;
            white-space: pre-line;
            box-shadow: 1px 1px 5px rgba(0, 0, 0, 0.1);
        }
        .output-box {
            width: 100%;
            height: 300px; /* Updated height */
            overflow: auto;
            white-space: pre-wrap;
            border: 1px solid #ddd;
            padding: 8px;
            box-sizing: border-box;
            margin-bottom: 20px;
            box-shadow: 1px 1px 5px rgba(0, 0, 0, 0.1);
        }
        footer {
            margin-top: 20px;
            text-align: center;
            padding: 10px;
            background-color: #f2f2f2;
            border-top: 1px solid #ddd;
            width: 100%;
        }
        .copy-icon {
            cursor: pointer;
            margin-left: 10px;
            font-size: 14px;
            color: #007bff;
        }
        .copy-notification {
            display: none;
            color: green;
            font-size: 12px;
            margin-left: 10px;
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        .btn {
            margin-bottom: 10px;
        }
        .file-list {
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }
        .save-notification {
            display: none;
            color: green;
            font-size: 14px;
            margin-top: 10px;
        }
        .centered {
            text-align: center;
        }
        .filename-group {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }
        .track-checkbox {
            transform: scale(1.2);
            margin: auto; /* Center the checkbox */
        }
        .output-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        .select-all {
            cursor: pointer;
            color: #007bff;
            margin-left: 10px; /* Added margin to separate the checkbox from the text */
        }
        .center-button {
            display: flex;
            justify-content: center;
            width: 100%;
        }
        .notification-container {
            display: flex;
            justify-content: center;
            width: 100%;
        }
        .narrow-column {
            width: 100px; /* Adjust the width as necessary */
        }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>
</head>
<body>
    <h1>Track Picker</h1>

    <h2>Load JSON Files</h2>
    <label for="jsonFiles" class="btn btn-secondary">
        Choose local JSON files...
        <input type="file" id="jsonFiles" name="jsonFiles" accept=".json" multiple style="display: none;" onchange="displaySelectedFiles()">
    </label>
    <div id="fileList" class="file-list"></div>
    <br><br>

    <label for="urlInput" class="centered">and/or enter comma-separated URLs:</label>
    <input type="text" id="urlInput" class="form-control" placeholder="Enter URLs here" style="width: 80%;">
    <br><br>

    <button class="btn btn-primary" onclick="loadFiles()">Load Files</button>

    <h2 id="trackDataHeader" style="display:none;">Track Data</h2>
    <div id="tables-container" class="table-container"></div>

    <button class="btn btn-primary" id="generateSessionButton" style="display: none;" onclick="generateSessionJson()">Generate Session JSON</button>

    <div id="sessionJsonSection" class="output-section" style="display: none;">
        <h2>Session JSON Output</h2>
        <textarea id="sessionJsonOutput" class="output-box" readonly style="width: 100%;"></textarea>
        <br>
        <div class="filename-group">
            <label for="filenameInput">Filename:</label>
            <input type="text" id="filenameInput" class="form-control" value="session.json" style="width: 40%; margin-left: 10px;">
        </div>
        <div class="center-button">
            <button class="btn btn-secondary" id="SaveSessionFile" style="display: inline-block;" onclick="saveSessionFile()">Save Session File</button>
        </div>
        <div class="notification-container">
            <div id="saveNotification" class="save-notification">File saved as: session.json</div>
        </div>

        <h2 id="blobUrlHeader" style="display:none;">Blob URL</h2>
        <div id="blobUrlOutput" class="centered"></div>
    </div>

    <footer></footer>

    <script>
        const mode = 'secure'; // Change this to switch modes
        let originalData = [];
        let trackDataStore = {};

        async function loadJSON(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Failed to fetch JSON from ${url}:`, error);
                alert(`Failed to fetch JSON from ${url}: ${error.message}`);
            }
        }

        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(JSON.parse(reader.result));
                reader.onerror = error => reject(error);
                reader.readAsText(file);
            });
        }

        async function loadFiles() {
            const tablesContainer = document.getElementById('tables-container');
            tablesContainer.innerHTML = '';
            originalData = [];
            trackDataStore = {};

            const fileList = document.getElementById('jsonFiles').files;
            const enteredURLs = document.getElementById('urlInput').value.split(',').map(url => url.trim()).filter(url => url);

            const allPromises = [];

            for (const file of fileList) {
                allPromises.push(readFile(file));
            }

            for (const url of enteredURLs) {
                if (url.includes('sessionURL=blob:')) {
                    allPromises.push(loadBlobURL(url));
                } else {
                    // Convert regular GitHub URLs to raw content URLs
                    const rawUrl = url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
                    allPromises.push(loadJSON(rawUrl));
                }
            }

            const allData = await Promise.all(allPromises);
            originalData = allData.flat().filter(data => data); // Filter out any null or undefined results

            originalData.forEach((data, dataIndex) => {
                if (data.reference && data.tracks) {
                    processSessionJSON(data, dataIndex);
                } else {
                    processGenomeJSON(data, dataIndex);
                }
            });

            if (originalData.length > 0) {
                document.getElementById('trackDataHeader').style.display = 'block';
                document.getElementById('generateSessionButton').style.display = 'inline-block';
            }
        }

        function uncompressString(enc) {
            enc = enc.replace(/\./g, '+').replace(/_/g, '/').replace(/-/g, '=');
            const compressedString = atob(enc);
            const compressedBytes = [];
            for (let i = 0; i < compressedString.length; i++) {
                compressedBytes.push(compressedString.charCodeAt(i));
            }
            const bytes = pako.inflateRaw(new Uint8Array(compressedBytes));
            let str = '';
            for (let b of bytes) {
                str += String.fromCharCode(b);
            }
            return str;
        }

        async function loadBlobURL(url) {
            try {
                const blobUrlParam = new URL(url).searchParams.get('sessionURL');
                if (!blobUrlParam) {
                    throw new Error('Invalid blob URL: sessionURL parameter is missing');
                }
                const blobUrl = blobUrlParam.replace('blob:', '');
                const decompressedData = uncompressString(blobUrl);
                return JSON.parse(decompressedData);
            } catch (error) {
                console.error(`Failed to process blob URL ${url}:`, error);
                alert(`Failed to process blob URL ${url}: ${error.message}`);
            }
        }

        function processSessionJSON(data, dataIndex) {
            const table = document.createElement('table');

            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th>Track Name</th>
                    <th class="narrow-column">Select<br><input type="checkbox" class="select-all" onclick="toggleSelectAll(this)" style="transform: scale(1.2); margin: 0;"></th>
                    ${mode !== 'secure' ? '<th>Track URLs</th><th>Index URLs</th><th>Track Data</th>' : ''}
                </tr>
            `;
            table.appendChild(thead);

            const tbody = document.createElement('tbody');

            // Add reference row
            const referenceData = JSON.stringify(data.reference);
            trackDataStore['reference'] = {
                trackData: referenceData,
                trackURL: data.reference.fastaURL,
                indexURL: data.reference.indexURL,
                fastaURL: data.reference.fastaURL
            };
            const refRow = document.createElement('tr');
            refRow.innerHTML = `
                <td>Reference</td>
                <td class="narrow-column"><input type="checkbox" class="track-checkbox" id="reference" style="transform: scale(1.2); margin: auto;"></td>
                ${mode !== 'secure' ? `<td class="scroll-box">${data.reference.fastaURL}</td>
                <td class="scroll-box">${data.reference.indexURL}</td>
                <td class="scroll-box">${referenceData}</td>` : ''}
            `;
            tbody.appendChild(refRow);

            data.tracks.forEach((track, index) => {
                if (track.url) {
                    const row = document.createElement('tr');
                    const trackId = `track-${dataIndex}-${index}`;
                    trackDataStore[trackId] = {
                        trackURL: track.url || '',
                        indexURL: track.indexURL || '',
                        trackData: JSON.stringify(track),
                        fastaURL: data.reference.fastaURL
                    };

                    row.innerHTML = `
                        <td class="scroll-box">${track.name || track.filename}</td>
                        <td class="narrow-column"><input type="checkbox" class="track-checkbox" id="${trackId}" style="transform: scale(1.2); margin: auto;"></td>
                        ${mode !== 'secure' ? `<td class="scroll-box">${track.url}</td>
                        <td class="scroll-box">${track.indexURL || ''}</td>
                        <td class="scroll-box">${JSON.stringify(track)}</td>` : ''}
                    `;
                    tbody.appendChild(row);
                }
            });

            table.appendChild(tbody);
            document.getElementById('tables-container').appendChild(table);
        }

        function processGenomeJSON(genome, dataIndex) {
            const table = document.createElement('table');

            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th>Track Name</th>
                    <th class="narrow-column">Select<br><input type="checkbox" class="select-all" onclick="toggleSelectAll(this)" style="transform: scale(1.2); margin: 0;"></th>
                    ${mode !== 'secure' ? '<th>Track URLs</th><th>Index URLs</th><th>Track Data</th>' : ''}
                </tr>
            `;
            table.appendChild(thead);

            const tbody = document.createElement('tbody');

            // Add reference row
            const referenceData = JSON.stringify({
                id: genome.id,
                name: genome.name,
                fastaURL: genome.fastaURL,
                indexURL: genome.indexURL,
                cytobandURL: genome.cytobandURL,
                aliasURL: genome.aliasURL
            });
            trackDataStore['reference'] = {
                trackData: referenceData,
                trackURL: genome.fastaURL,
                indexURL: genome.indexURL,
                fastaURL: genome.fastaURL
            };
            const refRow = document.createElement('tr');
            refRow.innerHTML = `
                <td>Reference</td>
                <td class="narrow-column"><input type="checkbox" class="track-checkbox" id="reference" style="transform: scale(1.2); margin: auto;"></td>
                ${mode !== 'secure' ? `<td class="scroll-box">${genome.fastaURL}</td>
                <td class="scroll-box">${genome.indexURL}</td>
                <td class="scroll-box">${referenceData}</td>` : ''}
            `;
            tbody.appendChild(refRow);

            genome.tracks.forEach((track, index) => {
                const row = document.createElement('tr');
                const trackId = `track-${dataIndex}-${index}`;
                trackDataStore[trackId] = {
                    trackURL: track.url || '',
                    indexURL: track.indexURL || '',
                    trackData: JSON.stringify(track),
                    fastaURL: genome.fastaURL
                };

                row.innerHTML = `
                    <td class="scroll-box">${track.name}</td>
                    <td class="narrow-column"><input type="checkbox" class="track-checkbox" id="${trackId}" style="transform: scale(1.2); margin: auto;"></td>
                    ${mode !== 'secure' ? `<td class="scroll-box">${track.url}</td>
                    <td class="scroll-box">${track.indexURL || ''}</td>
                    <td class="scroll-box">${JSON.stringify(track)}</td>` : ''}
                `;
                tbody.appendChild(row);
            });

            table.appendChild(tbody);
            document.getElementById('tables-container').appendChild(table);
        }

        function displaySelectedFiles() {
            const fileList = document.getElementById('jsonFiles').files;
            const fileListDiv = document.getElementById('fileList');
            fileListDiv.innerHTML = '';

            for (const file of fileList) {
                const fileItem = document.createElement('div');
                fileItem.textContent = file.name;
                fileListDiv.appendChild(fileItem);
            }
        }

        function compressString(str) {
            const bytes = new Uint8Array(str.length);
            for (let i = 0; i < str.length; i++) {
                bytes[i] = str.charCodeAt(i);
            }
            const compressedBytes = pako.deflateRaw(bytes);
            const compressedString = String.fromCharCode.apply(null, compressedBytes);
            let enc = btoa(compressedString);
            return enc.replace(/\+/g, '.').replace(/\//g, '_').replace(/=/g, '-');
        }

        function generateSessionJson() {
            console.log("Generate Session JSON button clicked");
            const checkboxes = document.querySelectorAll('.track-checkbox:checked');
            console.log("Selected checkboxes:", checkboxes);
            const selectedTracks = Array.from(checkboxes).map(checkbox => {
                const trackId = checkbox.id;
                console.log("Selected track ID:", trackId);
                return JSON.parse(trackDataStore[trackId].trackData);
            });

            if (selectedTracks.length === 0) {
                alert('No tracks selected.');
                return;
            }

            const uniqueFastaURLs = new Set();
            const trackGroups = {};

            checkboxes.forEach(checkbox => {
                const trackId = checkbox.id;
                const { trackURL, fastaURL } = trackDataStore[trackId];

                uniqueFastaURLs.add(fastaURL);

                if (!trackGroups[trackURL]) {
                    trackGroups[trackURL] = [];
                }
                trackGroups[trackURL].push(JSON.parse(trackDataStore[trackId].trackData));
            });

            const selectedReference = trackDataStore['reference'];
            if (!selectedReference) {
                alert('Reference not found for the selected tracks.');
                return;
            }
            const referenceData = JSON.parse(selectedReference.trackData);

            const sessionJson = {
                version: "2.15.11",
                showSampleNames: false,
                reference: referenceData,
                locus: "all",
                roi: [],
                tracks: Object.values(trackGroups).flat()
            };

            if (mode !== 'secure') {
                document.getElementById('sessionJsonOutput').textContent = JSON.stringify(sessionJson, null, 2);
                document.getElementById('sessionJsonSection').style.display = 'block';
            } else {
                // Secure mode: Generate blob URL and display
                const compressedString = compressString(JSON.stringify(sessionJson));
                const blobUrl = `https://ink-blot.github.io/?sessionURL=blob:${compressedString}`;

                const link = document.createElement('a');
                link.href = blobUrl;
                link.textContent = 'Open Link';
                link.target = '_blank';

                const copyIcon = document.createElement('span');
                copyIcon.className = 'copy-icon';
                copyIcon.textContent = '📋';
                copyIcon.onclick = () => {
                    navigator.clipboard.writeText(blobUrl).then(() => {
                        const notification = document.getElementById('copyNotification');
                        notification.style.display = 'inline';
                        setTimeout(() => {
                            notification.style.display = 'none';
                        }, 2000);
                    });
                };

                const notification = document.createElement('span');
                notification.id = 'copyNotification';
                notification.className = 'copy-notification';
                notification.textContent = 'Link copied!';

                const output = document.getElementById('blobUrlOutput');
                output.innerHTML = '';
                output.appendChild(link);
                output.appendChild(copyIcon);
                output.appendChild(notification);

                document.getElementById('blobUrlHeader').style.display = 'block';
            }
        }

        function saveSessionFile() {
            const sessionJson = document.getElementById('sessionJsonOutput').textContent;
            const blob = new Blob([sessionJson], { type: "application/json" });
            const filename = document.getElementById('filenameInput').value;
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            document.getElementById('saveNotification').textContent = `File saved as: ${filename}`;
            document.getElementById('saveNotification').style.display = 'block';
        }

        function toggleSelectAll(selectAllCheckbox) {
            const table = selectAllCheckbox.closest('table');
            const checkboxes = table.querySelectorAll('.track-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }
    </script>
</body>
</html>
